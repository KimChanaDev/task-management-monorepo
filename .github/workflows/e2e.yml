name: E2E Tests

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "24.7.0"

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: taskuser
          POSTGRES_PASSWORD: taskpass
          POSTGRES_DB: taskdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U taskuser -d taskdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:8.2.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # timescaledb:
      #   image: timescale/timescaledb:latest-pg17
      #   env:
      #     POSTGRES_USER: analyticsuser
      #     POSTGRES_PASSWORD: analyticspass
      #     POSTGRES_DB: analyticsdb
      #   ports:
      #     - 5433:5432
      #   options: >-
      #     --health-cmd "pg_isready -U analyticsuser -d analyticsdb"
      #     --health-interval 10s
      #     --health-timeout 5s
      #     --health-retries 5

      # pulsar:
      #   image: apachepulsar/pulsar:4.1.1
      #   ports:
      #     - 6650:6650
      #     - 8080:8080
      #   options: >-
      #     --health-cmd "bin/pulsar-admin brokers healthcheck"
      #     --health-interval 30s
      #     --health-timeout 10s
      #     --health-retries 5

      # minio:
      #   image: minio/minio:RELEASE.2025-09-07T16-13-09Z-cpuv1
      #   env:
      #     MINIO_ROOT_USER: minioadmin
      #     MINIO_ROOT_PASSWORD: minioadmin
      #   ports:
      #     - 9000:9000
      #     - 9001:9001
      #   options: >-
      #     --health-cmd "curl -f http://localhost:9000/minio/health/live"
      #     --health-interval 30s
      #     --health-timeout 20s
      #     --health-retries 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Setup Protocol Buffers
        uses: arduino/setup-protoc@v3.0.0

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx turbo run prisma:generate

      - name: Generate gRPC types
        run: npx turbo run generate-ts-proto

      - name: Build packages
        run: npm run build

      - name: Run database migrations
        run: |
          cd apps/auth-service
          DATABASE_URL="postgresql://taskuser:taskpass@localhost:5432/taskdb?schema=auth" npx prisma migrate deploy

          cd ../task-service
          DATABASE_URL="postgresql://taskuser:taskpass@localhost:5432/taskdb?schema=task" npx prisma migrate deploy

          # cd ../file-service
          # DATABASE_URL="postgresql://taskuser:taskpass@localhost:5432/taskdb?schema=file" npx prisma migrate deploy

          # cd ../analytics-service
          # DATABASE_URL="postgresql://analyticsuser:analyticspass@localhost:5433/analyticsdb?schema=analytics" npx prisma migrate deploy

      - name: Start services
        run: |
          # Start auth service
          cd apps/auth-service
          DATABASE_URL="postgresql://taskuser:taskpass@localhost:5432/taskdb?schema=auth" \
          NODE_ENV="test" \
          APP_VERSION="1.0.0" \
          HTTP_PORT=4000 \
          GRPC_PORT=5000 \
          JWT_SECRET="test-jwt-secret-key-for-e2e-testing" \
          ACCESS_TOKEN_EXPIRES_IN="15m" \
          REFRESH_TOKEN_EXPIRES_IN="7d" \
          REDIS_HOST="localhost" \
          REDIS_PORT=6379 \
          npm run start:prod &

          # Start task service
          cd ../task-service
          DATABASE_URL="postgresql://taskuser:taskpass@localhost:5432/taskdb?schema=task" \
          NODE_ENV="test" \
          APP_VERSION="1.0.0" \
          HTTP_PORT=4001 \
          GRPC_PORT=5001 \
          AUTH_SERVICE_GRPC_URL="localhost:5000" \
          PULSAR_SERVICE_URL="pulsar://localhost:6650" \
          npm run start:prod &

          # # Start analytics service
          # cd ../analytics-service
          # DATABASE_URL="postgresql://analyticsuser:analyticspass@localhost:5433/analyticsdb?schema=analytics" \
          # NODE_ENV="test" \
          # APP_VERSION="1.0.0" \
          # HTTP_PORT=4005 \
          # GRPC_PORT=5005 \
          # PULSAR_SERVICE_URL="pulsar://localhost:6650" \
          # npm run start:prod &

          # # Start file service
          # cd ../file-service
          # DATABASE_URL="postgresql://taskuser:taskpass@localhost:5432/taskdb?schema=file" \
          # NODE_ENV="test" \
          # APP_VERSION="1.0.0" \
          # HTTP_PORT=4006 \
          # GRPC_PORT=50046 \
          # MINIO_ENDPOINT="localhost" \
          # MINIO_PORT=9000 \
          # MINIO_USE_SSL=false \
          # MINIO_ACCESS_KEY="minioadmin" \
          # MINIO_SECRET_KEY="minioadmin" \
          # MINIO_BUCKET_NAME="task-files" \
          # MAX_FILE_SIZE=10485760 \
          # ALLOWED_FILE_TYPES="image/jpeg,image/png,image/gif,image/webp" \
          # THUMBNAIL_WIDTH=200 \
          # THUMBNAIL_HEIGHT=200 \
          # THUMBNAIL_QUALITY=80 \
          # npm run start:prod &

          # # Start notification service
          # cd ../notification-service
          # NODE_ENV="test" \
          # APP_VERSION="1.0.0" \
          # HTTP_PORT=4004 \
          # PULSAR_SERVICE_URL="pulsar://localhost:6650" \
          # CLIENT_URL="http://localhost:4003" \
          # REDIS_URL="redis://localhost:6379" \
          # npm run start:prod &

          # Start GraphQL gateway
          cd ../graphql-gateway
          NODE_ENV="test" \
          APP_VERSION="1.0.0" \
          HTTP_PORT=4002 \
          AUTH_SECURE_COOKIES=false \
          AUTH_SERVICE_GRPC_URL="localhost:5000" \
          TASK_SERVICE_GRPC_URL="localhost:5001" \
          ANALYTICS_SERVICE_GRPC_URL="localhost:5005" \
          FILE_SERVICE_GRPC_URL="localhost:50046" \
          ACCESS_TOKEN_EXPIRES_IN="15m" \
          REFRESH_TOKEN_EXPIRES_IN="7d" \
          CLIENT_URL="http://localhost:4003" \
          npm run start:prod &

          # Start Svelte web app
          cd ../svelte-web
          GRAPHQL_GATWAY_URL="http://localhost:4002" \
          PUBLIC_GRAPHQL_GATWAY_URL="http://localhost:4002" \
          PUBLIC_NOTIFICATION_WS_URL="http://localhost:4004" \
          PUBLIC_AUTH_SECURE_COOKIES=false \
          npm run preview -- --port 4003 &

          # Wait for services to be ready
          echo "Waiting for services to start..."
          sleep 45

          # Check if services are responding
          echo "Checking service health..."
          for i in {1..30}; do
            if curl -f http://localhost:4002/healthcheck 2>/dev/null; then
              echo "GraphQL gateway is ready"
              break
            fi
            echo "Waiting for GraphQL gateway... ($i/30)"
            sleep 2
          done

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: |
          cd apps/svelte-web
          npx playwright test
        env:
          BASE_URL: http://localhost:4003
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: apps/svelte-web/playwright-report/
          retention-days: 30

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: apps/svelte-web/test-results/
          retention-days: 7
