name: Update Domain Configuration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production
      domain:
        description: "New domain (e.g., example.com) - leave empty to use DOMAIN_NAME secret"
        required: false
        type: string
      protocol:
        description: "Protocol for URLs"
        required: true
        type: choice
        options:
          - https
          - http
        default: https
      secure_cookies:
        description: "Enable secure cookies (true for https, false for http)"
        required: true
        type: choice
        options:
          - "true"
          - "false"
        default: "true"

jobs:
  update-domain:
    name: Update Domain - ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.29.0"

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
          else
            echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
          fi
          chmod 600 $HOME/.kube/config

          echo "üîó Connecting to Kubernetes cluster..."
          kubectl cluster-info

      - name: Determine domain and protocol
        id: config
        run: |
          # Use input domain if provided, otherwise use secret
          if [ -n "${{ github.event.inputs.domain }}" ]; then
            DOMAIN="${{ github.event.inputs.domain }}"
          elif [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
            DOMAIN="${{ secrets.DOMAIN_NAME }}"
          else
            echo "‚ùå No domain provided and DOMAIN_NAME secret not set!"
            exit 1
          fi

          PROTOCOL="${{ github.event.inputs.protocol }}"
          SECURE_COOKIES="${{ github.event.inputs.secure_cookies }}"

          # Determine WebSocket protocol based on HTTP protocol
          if [ "$PROTOCOL" == "https" ]; then
            WS_PROTOCOL="wss"
          else
            WS_PROTOCOL="ws"
          fi

          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "protocol=$PROTOCOL" >> $GITHUB_OUTPUT
          echo "ws_protocol=$WS_PROTOCOL" >> $GITHUB_OUTPUT
          echo "secure_cookies=$SECURE_COOKIES" >> $GITHUB_OUTPUT

          echo "üìç Domain: $DOMAIN"
          echo "üìç Protocol: $PROTOCOL"
          echo "üìç WebSocket: $WS_PROTOCOL"
          echo "üìç Secure Cookies: $SECURE_COOKIES"

      - name: Update Ingress domain
        run: |
          DOMAIN="${{ steps.config.outputs.domain }}"
          echo "üåê Updating Ingress host domain..."

          # Update ingress hosts
          sed -i "s/host: .*/host: $DOMAIN/g" k8s/ingress/ingress.yaml

          # Also handle api subdomain if exists
          if grep -q "api\." k8s/ingress/ingress.yaml; then
            sed -i "s/host: api\..*/host: api.$DOMAIN/g" k8s/ingress/ingress.yaml
          fi

          echo "  ‚úÖ Ingress ‚Üí $DOMAIN"

      - name: Update ConfigMaps
        run: |
          DOMAIN="${{ steps.config.outputs.domain }}"
          PROTOCOL="${{ steps.config.outputs.protocol }}"
          WS_PROTOCOL="${{ steps.config.outputs.ws_protocol }}"
          SECURE_COOKIES="${{ steps.config.outputs.secure_cookies }}"

          echo "üìù Updating ConfigMaps..."

          # Svelte Web ConfigMap
          if [ -f "k8s/apps/svelte-web/configmap.yaml" ]; then
            sed -i "s|PUBLIC_GRAPHQL_GATWAY_URL: .*|PUBLIC_GRAPHQL_GATWAY_URL: \"$PROTOCOL://$DOMAIN\"|g" k8s/apps/svelte-web/configmap.yaml
            sed -i "s|PUBLIC_NOTIFICATION_WS_URL: .*|PUBLIC_NOTIFICATION_WS_URL: \"$WS_PROTOCOL://$DOMAIN\"|g" k8s/apps/svelte-web/configmap.yaml
            sed -i "s|PUBLIC_AUTH_SECURE_COOKIES: .*|PUBLIC_AUTH_SECURE_COOKIES: \"$SECURE_COOKIES\"|g" k8s/apps/svelte-web/configmap.yaml
            echo "  ‚úÖ svelte-web configmap updated"
            echo "     - PUBLIC_GRAPHQL_GATWAY_URL: $PROTOCOL://$DOMAIN"
            echo "     - PUBLIC_NOTIFICATION_WS_URL: $WS_PROTOCOL://$DOMAIN"
            echo "     - PUBLIC_AUTH_SECURE_COOKIES: $SECURE_COOKIES"
          fi

          # Notification Service ConfigMap
          if [ -f "k8s/apps/notification-service/configmap.yaml" ]; then
            sed -i "s|CLIENT_URL: .*|CLIENT_URL: \"$PROTOCOL://$DOMAIN\"|g" k8s/apps/notification-service/configmap.yaml
            echo "  ‚úÖ notification-service configmap updated"
            echo "     - CLIENT_URL: $PROTOCOL://$DOMAIN"
          fi

          # GraphQL Gateway ConfigMap
          if [ -f "k8s/apps/graphql-gateway/configmap.yaml" ]; then
            sed -i "s|CLIENT_URL: .*|CLIENT_URL: \"$PROTOCOL://$DOMAIN\"|g" k8s/apps/graphql-gateway/configmap.yaml
            sed -i "s|AUTH_SECURE_COOKIES: .*|AUTH_SECURE_COOKIES: \"$SECURE_COOKIES\"|g" k8s/apps/graphql-gateway/configmap.yaml
            echo "  ‚úÖ graphql-gateway configmap updated"
            echo "     - CLIENT_URL: $PROTOCOL://$DOMAIN"
            echo "     - AUTH_SECURE_COOKIES: $SECURE_COOKIES"
          fi

      - name: Apply updated manifests
        run: |
          echo "üì¶ Applying updated manifests..."

          # Apply Ingress
          kubectl apply -f k8s/ingress/ingress.yaml
          echo "  ‚úÖ Ingress applied"

          # Apply ConfigMaps
          kubectl apply -f k8s/apps/svelte-web/configmap.yaml
          kubectl apply -f k8s/apps/notification-service/configmap.yaml
          kubectl apply -f k8s/apps/graphql-gateway/configmap.yaml
          echo "  ‚úÖ ConfigMaps applied"

      - name: Restart deployments to apply new ConfigMaps
        run: |
          echo "üîÑ Restarting deployments to apply new ConfigMaps..."
          NAMESPACE="task-platform-apps"

          # Restart each deployment
          kubectl rollout restart deployment/svelte-web -n $NAMESPACE
          echo "  ‚úÖ svelte-web restarting..."

          kubectl rollout restart deployment/notification-service -n $NAMESPACE
          echo "  ‚úÖ notification-service restarting..."

          kubectl rollout restart deployment/graphql-gateway -n $NAMESPACE
          echo "  ‚úÖ graphql-gateway restarting..."

      - name: Wait for rollouts to complete
        run: |
          echo "‚è≥ Waiting for rollouts to complete..."
          NAMESPACE="task-platform-apps"

          kubectl rollout status deployment/svelte-web -n $NAMESPACE --timeout=120s
          echo "  ‚úÖ svelte-web ready"

          kubectl rollout status deployment/notification-service -n $NAMESPACE --timeout=120s
          echo "  ‚úÖ notification-service ready"

          kubectl rollout status deployment/graphql-gateway -n $NAMESPACE --timeout=120s
          echo "  ‚úÖ graphql-gateway ready"

      - name: Summary
        run: |
          DOMAIN="${{ steps.config.outputs.domain }}"
          PROTOCOL="${{ steps.config.outputs.protocol }}"
          WS_PROTOCOL="${{ steps.config.outputs.ws_protocol }}"
          SECURE_COOKIES="${{ steps.config.outputs.secure_cookies }}"

          echo ""
          echo "============================================"
          echo "‚úÖ Domain Update Complete!"
          echo "============================================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Domain: $DOMAIN"
          echo "Protocol: $PROTOCOL (WebSocket: $WS_PROTOCOL)"
          echo "Secure Cookies: $SECURE_COOKIES"
          echo ""
          echo "Updated resources:"
          echo "  ‚Ä¢ Ingress: $DOMAIN"
          echo "  ‚Ä¢ svelte-web ConfigMap"
          echo "  ‚Ä¢ notification-service ConfigMap"
          echo "  ‚Ä¢ graphql-gateway ConfigMap"
          echo ""
          echo "Restarted deployments:""
          echo "  ‚Ä¢ svelte-web"
          echo "  ‚Ä¢ notification-service"
          echo "  ‚Ä¢ graphql-gateway"
          echo "============================================"
